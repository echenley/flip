(function(React){React.initializeTouchEvents(true);var PureRenderMixin=React.addons.PureRenderMixin;var moveEnabled=false;var touchable=true;var keyIsDown=false;var levels=[{front:[["b","bk","xb"],["r","","b"],["yr","x","E"]],back:[["","b","xb"],["b","yrb","x"],["x","",""]],startPosition:{x:0,y:1}},{front:[["","yr","","E"],["","r","b",""],["","","r",""],["x","f","r","x"]],back:[["","fr","",""],["yb","br","",""],["x","","","k"],["","","y",""]],startPosition:{x:0,y:0}},{front:[["b","b","yb","fb","k"],["","b","b","yr",""],["r","","xrb","r",""],["yr","b","b","br","y"],["","","x","f",""]],back:[["r","xr","r","ybr","x"],["yr","r","b","b",""],["r","fr","Ebr","xr","by"],["r","b","b","b","b"],["","x","f","","y"]],startPosition:{x:0,y:0}}];levels.forEach(function(level,i){level.level=i+1;level.height=level.front.length;level.width=level.front[0].length});var Flip=React.createClass({displayName:"Flip",mixins:[PureRenderMixin],togglePeek:function(){var peek=this.state.peek;var flipped=this.state.flipped;this.setState({peek:!peek,flipped:!flipped})},flip:function(axis){var playerPosition=this.state.playerPosition;var boardBoundary,oppositeAxis,flipX,flipY;if(axis==="x"){boardBoundary=this.state.currentLevel.height;oppositeAxis="y";flipX=true;flipY=false}else{boardBoundary=this.state.currentLevel.width;oppositeAxis="x";flipX=false;flipY=true}playerPosition[oppositeAxis]=boardBoundary-playerPosition[oppositeAxis]-1;this.setState({playerPosition:playerPosition,flipX:flipX?!this.state.flipX:this.state.flipX,flipY:flipY?!this.state.flipY:this.state.flipY,flipped:!this.state.flipped});setTimeout(function(){this.performTileEvents(playerPosition)}.bind(this),500)},move:function(direction){var tileset=this.state.flipped?this.state.currentLevel.back:this.state.currentLevel.front;var from=this.state.playerPosition;var invertY=this.state.flipX?-1:1,invertX=this.state.flipY?-1:1;var to={x:from.x+direction.x*invertX,y:from.y+direction.y*invertY};if(!moveEnabled||this.state.death){return}if(this.isValidMove(from,to,direction,tileset)){moveEnabled=false;this.setState({playerPosition:to});setTimeout(function(){this.performTileEvents(to,tileset)}.bind(this),100)}},isValidMove:function(from,to,direction,tileset){var wallExists;if(this.state.flipX){direction.y*=-1}if(this.state.flipY){direction.x*=-1}function directionLetterOf(vector){if(vector.x===1){return"r"}else if(vector.y===1){return"b"}}function hasWallClass(tile,directionLetter){var tileCharacters=tileset[tile.y][tile.x].split("");return tileCharacters.indexOf(directionLetter)!==-1}if(to.x<0||to.x>this.state.currentLevel.width-1||to.y<0||to.y>this.state.currentLevel.height-1){return false}if(direction.x===1||direction.y===1){wallExists=hasWallClass(from,directionLetterOf(direction))}else{wallExists=hasWallClass(to,directionLetterOf({x:-direction.x,y:-direction.y}))}if(wallExists){return false}return true},performTileEvents:function(tile,tileset){tileset=tileset||(this.state.flipped?this.state.currentLevel.back:this.state.currentLevel.front);var tileCharacters=tileset[tile.y][tile.x].split("");var newState={};function tileContains(letter){return tileCharacters.indexOf(letter)!==-1}if(tileContains("x")){this.flip("x")}else if(tileContains("y")){this.flip("y")}else{if(tileContains("k")&&!this.state.hasKey){newState.hasKey=true;newState.menuStatus="Got the key!"}else if(tileContains("f")){newState.menuStatus="Oops, burned alive!";newState.death=true}else if(tileContains("E")){this.checkWinCondition()}else{newState.menuStatus="Get to your spaceship."}this.setState(newState);moveEnabled=true}},checkWinCondition:function(){var newState={};if(!this.state.flipX&&this.state.hasKey){newState.win=true;newState.menuStatus="You did it!"}else if(this.state.flipX){newState.menuStatus="Your ship is upside down!"}else{newState.menuStatus="Oh no...where is your key?"}this.setState(newState)},getDimensions:function(height,width){var tileWidth=document.getElementById("player").offsetWidth;return{height:tileWidth*height+6+"px",width:tileWidth*width+6+"px"}},changeLevel:function(level){if(!levels[level]){return}var newBoardDimensions=this.getDimensions(levels[level].height,levels[level].width);this.setState({currentLevel:levels[level],playerPosition:{x:levels[level].startPosition.x,y:levels[level].startPosition.y},boardDimensions:newBoardDimensions,menuStatus:"Get to your spaceship.",flipX:false,flipY:false,flipped:false,peek:false,hasKey:false,win:false,death:false})},beforeMove:function(direction){if(this.state.win){return}if(this.state.peek){this.togglePeek()}else{this.move(direction)}},handleKeyEvent:function(e){var key=e.keyCode;if([32,37,38,39,40].indexOf(key)!==-1){e.preventDefault()}if(key===32&&!keyIsDown){keyIsDown=true;this.togglePeek()}else if(key===37){this.beforeMove({x:-1,y:0})}else if(key===38){this.beforeMove({x:0,y:-1})}else if(key===39){this.beforeMove({x:1,y:0})}else if(key===40){this.beforeMove({x:0,y:1})}},componentDidMount:function(){window.addEventListener("keydown",this.handleKeyEvent);window.addEventListener("keyup",function(){keyIsDown=false});this.setState({boardDimensions:this.getDimensions(this.state.currentLevel.height,this.state.currentLevel.width),peek:false});setTimeout(function(){moveEnabled=true},1e3)},getInitialState:function(){return{currentLevel:levels[0],playerPosition:{x:levels[0].startPosition.x,y:levels[0].startPosition.y},boardDimensions:{width:0,height:0},flipX:false,flipY:false,flipped:false,peek:true,hasKey:false,win:false,death:false,menuStatus:"Get to your spaceship.",totalLevels:levels.length}},concatenateBoard:function(a,b){return a.concat(b)},render:function(){var wrapperClass=this.state.peek?"peek":"";wrapperClass+=this.state.hasKey?" hasKey":"";wrapperClass+=this.state.win?" win":"";var gameBoardClass=this.state.flipped?"flipped":"";gameBoardClass+=this.state.flipX?" flipX":"";gameBoardClass+=this.state.flipY?" flipY":"";var playerClass=this.state.flipped?" flip":" unflip";playerClass+=this.state.win?" win":"";playerClass+=this.state.death?" dead":"";var playerPosition=this.state.playerPosition;var gridPosition={x:this.state.flipY?this.state.currentLevel.width-playerPosition.x-1:playerPosition.x,y:this.state.flipX?this.state.currentLevel.height-playerPosition.y-1:playerPosition.y};return React.DOM.div({id:"game-container"},HeaderMenu({level:this.state.currentLevel.level,totalLevels:this.state.totalLevels,titleClass:this.state.win?"spin":"",changeLevel:this.changeLevel}),React.DOM.div({id:"game-board-wrapper",style:this.state.boardDimensions,className:wrapperClass},GameBoard({gameBoardClasses:gameBoardClass,tileSets:{front:this.state.currentLevel.front.reduce(this.concatenateBoard),back:this.state.currentLevel.back.reduce(this.concatenateBoard)}}),Player({playerClass:playerClass,peeking:this.state.peek,position:gridPosition})),Hint({status:this.state.menuStatus}),Controls({sendMove:this.beforeMove,sendPeek:this.togglePeek}))}});var HeaderMenu=React.createClass({displayName:"HeaderMenu",toggleTouchable:function(){touchable=false;setTimeout(function(){touchable=true},500)},restartClickHandler:function(){this.toggleTouchable();this.props.changeLevel(this.props.level-1)},nextLevelClickHandler:function(){this.toggleTouchable();this.props.changeLevel(this.props.level)},prevLevelClickHandler:function(){this.toggleTouchable();if(this.props.level>1){this.props.changeLevel(this.props.level-2)}},render:function(){return React.DOM.div({className:"header"},React.DOM.h1({id:"title",className:this.props.titleClass},React.DOM.span({className:"title-flip"},"Flip")," Flip"),React.DOM.h3({id:"subtitle"},"Level ",this.props.level,"/",this.props.totalLevels),React.DOM.nav({className:"navigation"},React.DOM.a({className:"nav-item icon-left clickable",title:"Previous Level",onClick:this.prevLevelClickHandler,onTouchEnd:this.prevLevelClickHandler}),React.DOM.a({className:"nav-item icon-refresh clickable",title:"Restart Level",onClick:this.restartClickHandler,onTouchEnd:this.restartClickHandler}),React.DOM.a({className:"nav-item icon-right clickable",title:"Next Level",onClick:this.nextLevelClickHandler,onTouchEnd:this.nextLevelClickHandler})))}});var GameBoard=React.createClass({displayName:"GameBoard",render:function(){return React.DOM.div({id:"game-board",className:this.props.gameBoardClasses},BoardFace({id:"game-board-front",tileset:this.props.tileSets.front}),BoardFace({id:"game-board-back",tileset:this.props.tileSets.back}))}});var BoardFace=React.createClass({displayName:"BoardFace",render:function(){var tiles=this.props.tileset;return React.DOM.div({id:this.props.id,className:this.props.classes,style:this.props.boardDimensions},tiles.map(function(tileText,position){return Tile({tileText:tileText,key:position})},this))}});var Tile=React.createClass({displayName:"Tile",getTileClassOf:function(tileText){var tileClass="tile";if(!tileText){return tileClass}var fullClass={E:" icon-space-ship",x:" icon-flip-x",y:" icon-flip-y",b:" wall-bottom",r:" wall-right",k:" icon-key",f:" icon-fire"};tileText=tileText.split("");tileText.forEach(function(c){tileClass+=fullClass[c]||""});return tileClass},render:function(){return React.DOM.div({className:this.getTileClassOf(this.props.tileText)})}});var Player=React.createClass({displayName:"Player",getPosition:function(){var position=this.props.position;var tileWidth=50;var translateX=position.x*tileWidth,translateY=position.y*tileWidth,translateZ=this.props.peeking?"0":"4px";var gridTranslate="translate3d("+translateX+"px, "+translateY+"px, "+translateZ+")";return{transform:gridTranslate,webkitTransform:gridTranslate}},render:function(){var playerStyle=this.getPosition();var playerClass="tile icon-female"+this.props.playerClass;return React.DOM.div({ref:"player",className:playerClass,id:"player",style:playerStyle})}});var Hint=React.createClass({displayName:"Hint",render:function(){return React.DOM.div({id:"menu"},React.DOM.p({className:"instruction"},this.props.status))}});var Controls=React.createClass({displayName:"Controls",handleClick:function(direction){if(direction==="up"){direction={x:0,y:-1}}else if(direction==="down"){direction={x:0,y:1}}else if(direction==="left"){direction={x:-1,y:0}}else if(direction==="right"){direction={x:1,y:0}}this.props.sendMove(direction)},render:function(){return React.DOM.div({className:"controls"},React.DOM.div({className:"arrow-keys"},React.DOM.div({className:"arrow-keys-line"},React.DOM.a({className:"icon-arrow-up clickable",onClick:this.handleClick.bind(this,"up"),onTouchEnd:this.handleClick.bind(this,"up")})),React.DOM.div({className:"arrow-keys-line"},React.DOM.a({className:"icon-arrow-left clickable",onClick:this.handleClick.bind(this,"left"),onTouchEnd:this.handleClick.bind(this,"left")}),React.DOM.a({className:"icon-arrow-down clickable",onClick:this.handleClick.bind(this,"down"),onTouchEnd:this.handleClick.bind(this,"down")}),React.DOM.a({className:"icon-arrow-right clickable",onClick:this.handleClick.bind(this,"right"),onTouchEnd:this.handleClick.bind(this,"right")}))),React.DOM.a({className:"spacebar clickable",onClick:this.props.sendPeek,onTouchEnd:this.props.sendPeek}))}});React.renderComponent(Flip(null),document.getElementById("container"))})(React);